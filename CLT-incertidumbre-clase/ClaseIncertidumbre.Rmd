---
title: "Ejemplo de Estimación de incertidumbre en valoración de NaOH, empleando paquete `uLPAQ`"
author: "Sergio A. Gonzalez Monico, Andres Cabrera Orozco, Felipe Beltran"
date: "5/31/2021"
output:           rmdformats::downcute
---

# Instalación de paquetes

Primero cargamos los paquetes `usethis` y `devtools` para descargar los paquetes desde github.

```{r}
library(usethis)
library(devtools)
```

Luego, usando la funcion `install_github()` pasando como argumentos la dirección del repositorio en el cual está el paquete, y `force = TRUE` para evitar problemas durante la instalación.

```{r, eval = FALSE}
install_github('https://github.com/sergmonic/AtomicWeights/',force = TRUE)
install_github('https://github.com/sergmonic/uLPAQ/',force = TRUE)
```

Una vez instalados los paquetes, podemos agregarlos al entorno de trabajo utilizando la función `library()`.

```{r, message=F}
library(AtomicWeights)
library(uLPAQ)
```

Podemos acceder a las páginas de ayuda para cada una de las funciones mediante la función `help()` o `?`

```{r, eval = FALSE}
help(package="AtomicWeights")
help(package="uLPAQ")
```

# Procedimiento para la evaluación y estimación según la  [GUM](https://www.bipm.org/documents/20126/2071204/JCGM_100_2008_E.pdf/cb0ef43f-baa5-11cf-3f85-4dcd86f77bd6)

1. Identificar el mesurando

2. Identificar las fuentes de incertidumbre y la posible existencia de fuentes dominantes.

3. Clasificar las fuentes de incertidumbre en tipo A o tipo B.

4. Expresar la relación matemática entre el mesurando $Y$ y las variables de entrada $X_i$ de las cuales depende:

\begin{align}

Y = f(X_1, X_2, ..., x_n) 
\end{align}


Esta expresión debe contener cada cantidad que puede contribuir en la incertidumbre del resultado de la medición.

5. Estimar las incertidumbres asociadas a cada funte de error (contribuciones). Convertir a incertidumbres estándar.

 

6. Combinar las incertidumbres para obtener la **incertidumbre combinada**.

   Para sumas: \textit{U combinada}
        
     \begin{align}
    y = a + b, y = a - b
    \end{align}
    \begin{align}
    u_y = \sqrt{u^2_a + u^2_b}
    \end{align}
    Para Multiplicaciones: \textit{U combinada relativa}
        
     \begin{align}
    y = ab, y = a/b
    \end{align}
    \begin{align}
    u_y/y = \sqrt{(u_a/a)^2 + (u_b/b)^2}
    \end{align}
    

7. Calcular La **Incertidumbre expandida (U)** utilizando un factor de cubrimiento (k)

\begin{align}
U = ku
\end{align}
 
# Modelo Matematico del mesurando e identificación de fuentes de incertidumbre.


* Mesurando: Concentración molar de NaOH: obtenida mediante titulación volumétrica empleando KHP y con seguimiento potenciométrico.

* Fuentes:

    + Masa de KHP empleada para la estandarización (`m_kHP`) en g
    + Masa molar de KHP (`W_KHP`) en g/mol
    + Volumen gastado de solución de NaOH (`V_NaOH`) en mL
    + Pureza del KHP  (`P_KHP`) de forma fraccional (g/g)
    + Repetibilidad (R) obtenida de X muestras independientes (fraccional/relativa)
  
   
## Modelo matemático
 
 Para el cálculo de la concentración $C_{NaOH}$ de NaOH de una solución, la cual se valora haciendo reaccionar $m_{KHP}$ g de biftalato de potasio, el cual tiene una pureza de $m_{KHP}$ con un volumen de $V_{NaOH}$ de la solución problema:
 
 \begin{align}
 
 C_{NaOH} = \frac{1000 \; \cdot \; m_{KHP} \; \cdot \; P_{KHP} \; \cdot \ R}{W_{KHP} \; \cdot \; V_{NaOH} }
 \end{align}
 
 Podemos crear la función que relaciona la concentración del hidróxido de sodio `C_NaOH` con el factor de conversión, utilizando la función `function()` creando como argumentos cada uno de los parámetros del factor de conversión:
 
```{r}
C_NaOH<-function(m_KHP,
                 W_KHP,
                 V_NaOH,
                 P_KHP,
                 R){
  
  1000*m_KHP*P_KHP*R/(W_KHP*V_NaOH)
}
```
 
 
```{r, echo = F, eval = T, message = F}
library(qcc)
cause.and.effect(cause=list(m_KHP = '(g)',
                            W_KHP = '(g/mol)',
                            V_NaOH = c('material volumetrico', 'punto final'),
                            P_KHP = '(g/g)',
                             Repetibilidad= ''),
                 effect = 'Incertidumbre NaOH')
```

# Incertidumbre en masas molares

Fórmula molecular de KHP: $KC_8O_4H_5$

```{r, eval=FALSE}
help("getAtomicWeight")
help("getMolarMass")
```

```{r}
W_KHP=getMolarMass(atomsType = c("K", "C", "O", "H"),c(1,8,4,5))
```

#Incertidumbre en mediciones de volumen

```{r, eval =FALSE}
help("instVolumetrico")
```

# Volumen de NaOH gastado en la valoración

## Incertidumbre en la medición de NaOH con bureta 



```{r}
PF=puntoFinal(datosAnalisis$valoracionNaOH$V,
              datosAnalisis$valoracionNaOH$pH,
              intervalo_x = c(10,13))
PF
```



## Incertidumbre por el uso de material volumétrico (bureta de capacidad de 25 mL).


```{r, message = FALSE}
bureta_NaOH <- instVolumetrico(nominal=25,
                            subdivision =0.05 ,
                            tipo="bureta",
                            clase="A_AS",
                            volumen=PF$d1num$PE,
                            temp = 17.5)
```

## obtención de `V_NaOH` considerado material volumétrico y obtención de PF

```{r}
.V_NaOH=PF$d1num$PE
.u_V_NaOH=sqrt(PF$d1num$u_PE^2+bureta_NaOH$u_V^2)
V_NaOH=data.frame(V_NaOH=.V_NaOH,
                  u_V_NaOH=.u_V_NaOH)
V_NaOH
```


### Ejemplos con otros materiales


```{r}
balon100=instVolumetrico(nominal=100,tipo="balon",clase="A",temp=16)
```

```{r}
pipeta10=instVolumetrico(nominal=10,tipo="pipeta",clase="A_AS",temp=16)
```

```{r}
micropipeta=instVolumetrico(nominal=1,tipo="micropipeta",volumen=1,temp=16)
```


# Incertidumbre en medición de masa de KHP: mediciones gravimétricas


```{r, eval = F}
help(masa_minima)
```

```{r,echo=FALSE,results='hide',fig.keep='all'}
masa_minima(u_r = 0.1,densidad = 1636,balanza = "ME204")
```

```{r}
m_KHP=u_masa(lectura = 0.1026,densidad = 1636,balanza = "ME204")
m_KHP$m_s
```



# Incertidumbre en la pureza del biftalato

```{r, eval = FALSE}
help("pureza")
```


```{r}
P_KHP = pureza(0.999)
P_KHP
```

# Incertidumbre por repetibilidad

```{r}
R=1
u_R=0.0
```

# Estimación de la incertidumbre combinada

## Coeficientes de sensibilidad

```{r}
library(Deriv)
c_i=Deriv(C_NaOH,c("m_KHP","W_KHP","V_NaOH","P_KHP","R"))
c_i
```
### Valores de los coeficientes de sensibilidad, obtenido a partir de los valores de la variables de influencia


```{r}
v_c_i=c_i(m_KHP$m_s$ms,W_KHP$MM,V_NaOH$V_NaOH,P_KHP$P,R)
v_c_i
```

### vector recogiendo las incertdumbres estándar de la diferentes fuentes
```{r}
u_i=c(m_KHP$m_s$u_ms,W_KHP$u_MM,V_NaOH$u_V_NaOH,P_KHP$u_P,u_R)
u_i
```
# Incertidumbre combinada

```{r}
u_c=sqrt(sum((v_c_i*u_i)^2))
u_c
```


# Obtención de incertidumbre expandida
```{r}
k=2 # Se expande asumiendo una distribución normal, para una probabilidad de confianza del 95 %
U=k*u_c
U # Incertidumbre expandida
```
# Contribuciones de cada fuente

```{r}
contribuciones=(v_c_i*u_i)^2/u_c^2
pie(contribuciones,main="Contribuciones de fuentes de incertidumbre")
barplot(contribuciones*100,
        xlab="Fuentes de incertidumbre",
        ylab="Aporte a incertudumbre combinada (%)", 
        main="Contribuciones de fuentes de incertidumbre")
```

# Valor del mensurando

```{r}
.C_NaOH=C_NaOH(m_KHP$m_s$ms,W_KHP$MM,V_NaOH$V_NaOH,P_KHP$P,R)
```

```{r}
mensurando_C_NaOH=round(data.frame(C_NaOH=.C_NaOH,U_C_NaOH=U),5)
mensurando_C_NaOH
```




# Ejemplo con datos reales.


Para este ejemplo se utilizaran los datos resultantes de valoraciones repetidas de una muestra de cascara de huevo. Para determinar el porcentaje de carbonato de calcio $(CaCO_3)$ se determinó el contenido de calcio por gravimetría y por volumetría. En total, 20 grupos de laboratorio determinaron el contenido de calcio, mediante distintas metodologias de la siguiente manera:


* los grupos del 1 al 10 tomaron 100 mg de la muestra en la balanza `ME204`
* los grupos del 11 al 20 grupos tomaron 200 mg de la muestra en la balanza `AES220`

Cada muestra se llevó a volumen en balones tipo A de 50mL (1 a 10) y 100 mL (11 a 20) 

Luego de esto, se tomaron alicuotas de la siguiente manera:

* todos los grupos tomaron alicuota de 10 mL en una pipeta tipo A.

<!-- * De los grupos 6 al 10 tomaron una alicuota de 10 mL (pipeta tipo A) -->

<!-- * De los grupos 11 al 15 tomaron alicuota de 10 g en la balanza `ME204` -->
<!-- * De los grupos 16 al 20 tomaron una alicuota de 10 mL (pipeta tipo B). -->

Luego se llevó a cabo la valoración de cada una de las alícuotas de la siguiente manera:

* Las muestras 1 a 10 se llevaron a pH 10 y se titularon con EDTA 0.1 M en una bureta de 25 mL tipo A

* Las muestras 11 a 20 precipitaron con oxalato de amonio, filtraron, secaron, calcinaron a 1000 ºC y se pesaron en la balanza `ME204`.

Un resumen de las variables de procedimiento y los resultados experimentales se encuentran en la siguiente tabla: 

```{r echo = F}
masa.inicial <- c(rep(0.500,10),rep(1.000,10))
balanza.inicial <- c(rep('ME204',10),rep('AES220',10))
alicuota <- rep(10, 20)
clase.pipeta <- rep('A')
capacidad.bureta <- c(rep(25,10),rep(NA,10))
balanza.calcinacion <- c(rep(NA,10),rep('ME204',10))
set.seed(1234)
vol.EDTA <- c(round(rnorm(10,9.35,0.15),2), rep(NA,10))
masa.calcin <- c(rep(NA,10),round( rnorm(10,0.0525,0.001),4))

df1 <- data.frame(masa.inicial = masa.inicial, balanza.inicial = balanza.inicial, alicuota= alicuota, clase.pipeta = clase.pipeta, capacidad.bureta = capacidad.bureta, balanza.calcinacion = balanza.calcinacion,
                 vol.EDTA = vol.EDTA, masa.calcin=masa.calcin)

colnames(df1) <- c('Masa muestra (g)','balanza inicial', 'Alícuota (mL)', 'Clase pipeta alícuota', 'Capacidad de la bureta (mL)', 'balanza final', 'Volumen EDTA (mL)', 'Masa final (g)')

df3 <- rbind(df1,df1,df1)
df3$replica <- c(rep(1,20),rep(2,20),rep(3,20))
df3$`Volumen EDTA (mL)`[21:30] <-df3$`Volumen EDTA (mL)`[1:10] + rnorm(10, sd = 0.15)
df3$`Volumen EDTA (mL)`[41:50] <-df3$`Volumen EDTA (mL)`[1:10] + rnorm(10, sd = 0.15)
df3$`Volumen EDTA (mL)` <- round(df3$`Volumen EDTA (mL)`,2)

df3$`Masa final (g)`[31:40] <-df3$`Masa final (g)`[11:20] + rnorm(10, sd = 0.001)
df3$`Masa final (g)`[51:60] <-df3$`Masa final (g)`[11:20] + rnorm(10, sd = 0.001)
df3$`Masa final (g)` <- round(df3$`Masa final (g)`,4)

df3$`Masa final (g)`[c(12,32,52)] <- df3$`Masa final (g)`[c(12,32,52)] - 0.04


knitr::kable(df3)
write.csv(df3, 'tablaEjemplo.csv', row.names = F)
```

Podemos importar esta tabla de datos, disponible en este [enlace](https://github.com/pipoelpipas/Statistics-in-R-2/raw/main/CLT-incertidumbre-clase/tablaEjemplo.csv):

```{r, message = F}
library(downloader)
url1 <- 'https://github.com/pipoelpipas/Statistics-in-R-2/raw/main/CLT-incertidumbre-clase/tablaEjemplo.csv'
download(url1, destfile = 'tablaEjemplo.csv')
datos <- read.csv('tablaEjemplo.csv', sep = ',', header = T)
```

 Una vez tenemos cargados los datos, podemos dividirlos en grupos mas pequeños, por ejemplo un grupo de volumetría y otro de gravimetría:
 
```{r message = F}
library(dplyr)
gravimetria <- filter(datos, balanza.final == 'ME204')
volumetria <- filter(datos, Capacidad.de.la.bureta..mL. == 25)
```
 
 
## Analisis exploratorio
 
 Podemos realizar análisis exploratorio de datos, tal como se ha revisado en el curso a cada uno de los grupos de experimentos, antes de proceder a calcular el contenido de carbonato de calcio en la cáscara de huevo.
 
```{r}
masas <- unlist(select(gravimetria, Masa.final..g.))
volumenes <- unlist(select(volumetria, Volumen.EDTA..mL.))
par(mfrow = c(1,2))
boxplot(masas, main = 'boxplot de masas')
boxplot(volumenes, main = 'boxplot de volumenes')
```


## Volumetria 

### Modelo Matematico del  mesurando e identificación de fuentes de incertidumbre

Para el caso de la volumetria, podemos expresar el modelo de la siguiente forma:

 \begin{align}
 
\%CaCO_3 = \frac{FD_{muestra} \;\cdot\; V_{EDTA}\;\cdot\; W_{CaCO_3}\;\cdot\; R}{m_{muestra}} 

 \end{align}


 
```{r, echo = F, eval = T, message = F}
library(qcc)
cause.and.effect(cause=list(FD_muestra = c('balon','pipeta 10 mL'),
                            W_CaCO3 = '(g/mol)',
                            V_EDTA = c('material volumetrico', 'punto final'),
                            m_muestra = 'balanza (g)',
                             Repetibilidad= '1'),
                 effect = expression(paste(' % CaCO3')))
```
En donde:

* $FD\_{muestra}$ es el factor de dilución correspondiente a la toma de la alícuota con una pipeta de 10 mL a partir de un volumen de aforo en un balón volumétrico.
* $W\_CaCO_3$: Es la masa molar del carbonato de calcio
* $V\_EDTA$ es el volumen de EDTA gastado en la titulación, utilizando un material volumétrico (bureta) y un método para determinar el punto final (indicador, o mediante una curva potenciométrica)

* $m\_muestra$ es la masa inicial de la muestra, medida en una balanza específica.
* $Repetibilidad$ La repetibilidad de los experimentos expresada como la desviación de las réplicas, con un valor de 1 y un aporte a la incertidumbre de $U_R = \dfrac{s}{\sqrt{n}}$.


### Incertidumbre por masa molar de $CaCO_3$

```{r}
library(AtomicWeights)
W_CaCO3 = getMolarMass(atomsType = c('Ca','C','O'),
                       c(1,1,3)
                       )
W_CaCO3
```
### Volumen de EDTA gastado en la valoración.

#### Incertidumbre en la medición del punto final

```{r, echo = FALSE, fig.show='hide'}
library(titrationCurves)
curva <- metal_edta(conc.metal = 0.0187,eqpt = TRUE)
colnames(curva) <- c('Volumen de EDTA (mL)', 'pCa')
write.csv(curva, 'curvaEDTA.csv', row.names = F)

```

Para ilustrar de nuevo el caso de la determinación de la incertidumbre en el punto final de la titulación, podemos cargar los datos contenidos en el archivo `curvaEDTA.csv` disponible en este [link](https://raw.githubusercontent.com/pipoelpipas/Statistics-in-R-2/main/CLT-incertidumbre-clase/curvaEDTA.csv) 

Primero cargamos los datos a R:

```{r, message = F}
library(downloader)
url2 <- 'https://github.com/pipoelpipas/Statistics-in-R-2/raw/main/CLT-incertidumbre-clase/curvaEDTA.csv'
download(url2, destfile = 'curvaEDTA.csv')
curvaEDTA  <- read.csv('curvaEDTA.csv', sep = ',', header = TRUE)
```

Podemos graficar la curva de titulación:

```{r}
plot(curvaEDTA$Volumen.de.EDTA..mL.,
     curvaEDTA$pCa,
     type = 'l',
     xlab = 'Volumen de EDTA (mL)',
     ylab = 'pCa'
)
```


Luego, podemos utilizar la función `puntoFinal` del paquete `uLPAQ` para estimar la incertidumbre por la determinación del punto final a partir de esta curva:


```{r, message = F, warning=FALSE}
library(uLPAQ)
PF.EDTA <- puntoFinal(curvaEDTA$Volumen.de.EDTA..mL.,
                 curvaEDTA$pCa)
PF
```



#### Incertidumbre por el uso de material volumétrico (bureta de capacidad de 25mL)

```{r}
bureta_EDTA <- instVolumetrico(nominal=25,
                            subdivision =0.05 ,
                            tipo="bureta",
                            clase="A_AS",
                            volumen=PF.EDTA$d1num$PE,
                            temp = 17.5)

bureta_EDTA
```
 

## Gravimetria


